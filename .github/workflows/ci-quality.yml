name: CI Quality Gates

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: ci-quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  frontend_quality:
    name: Frontend Quality (lint + typecheck + build)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Lint (blocking)
        run: npm run lint

      - name: Typecheck (blocking)
        run: npm run typecheck

      - name: Build (blocking)
        run: npm run build

  docker_quality:
    name: Container Quality (hadolint + trivy + smoke test)
    runs-on: ubuntu-latest
    needs: [frontend_quality]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Hadolint (Dockerfile best practices)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: Build image (local)
        run: docker build -t portfolio:ci .

      - name: Trivy scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "portfolio:ci"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Smoke test (container must respond)
        run: |
          docker run -d --name portfolio_ci -p 8080:80 portfolio:ci
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:8080/ >/dev/null; then
              echo "Smoke test OK"
              exit 0
            fi
            sleep 1
          done
          echo "Smoke test FAILED"
          docker logs portfolio_ci || true
          exit 1